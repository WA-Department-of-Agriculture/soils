---
title: "Import your data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Import your data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

You can immediately install {soils}, create a new template project, and render
example reports, as demonstrated in the last two tutorials. However, you will
need to customize and edit the content to fit your project, shown in the next
three tutorials: [**Customize &
write**](https://wa-department-of-agriculture.github.io/soils/articles/customize.html),
[**Render
reports**](https://wa-department-of-agriculture.github.io/soils/articles/render.html),
and
[**Troubleshoot**](https://wa-department-of-agriculture.github.io/soils/articles/troubleshoot.html).

## Access the example datasets

An example dataset and data dictionary are included in every {soils} project.
Access the `.csv` files in the `data` folder, or load the package and call the
dataframes by name as shown below.

<details closed>

<summary>Load {soils} and see first five rows of each dataframe</summary>

```{r}
library(soils)
head(washi_data, 5) |> knitr::kable()
head(data_dictionary, 5) |> knitr::kable()
```

</details>

Use `washi_data` and `data_dictionary` as templates when formatting your own
data to use in {soils} functions and reports.

## Data template

Your data must contain the below required columns and each soil measurement must
be in its own column, as shown in `washi_data`.

<details closed>

<summary>Glimpse at the example data</summary>

```{r}
dplyr::glimpse(washi_data)
```

</details>

### Metadata (columns A–I: `year` through `longitude`)

Your data **must have the below required columns**. However, only the columns in
**bold** are required to have values. Put another way, your data must have these
column names, even if every row is blank.

-   **`year <int>`** is used to select samples to be included in the report.

-   **`sample_id <chr>`** is a unique identifier for each soil sample. Can be
    any alphanumeric value or a combination of `year`, `producer_id`, and
    `field_id`.

-   `farm_name <chr>` is included at the top of the report. If blank, it is
    replaced with "Farm: `producer_id`".

-   **`producer_id <chr>`** is a unique identifier for each producer. Reports
    are generated for each `producer_id` within a given year. This can be an
    alphanumeric value or the producer’s name.

-   **`field_id <chr>`** is to distinguish fields when a producer has multiple
    samples in the same year. Must be unique within a `producer_id` and `year`
    combination. Can be any alphanumeric value or a producer-assigned field
    name.

-   `county <chr>` is used to group and summarize samples from the same county
    as the producer. Can be blank.

-   `crop <chr>` is used to group and summarize samples from the same crop as
    the producer. Can be blank.

-   `latitude <int>` and `longitude <int>`are used to map each sample point. If
    blank, the map will not be included. Coordinates must be provided in decimal
    degrees. `latitude` may range from -90 to 90. `longitude` may range from
    -180 to 180.

-   **Each soil measurement** must have its own column in the dataset and a
    corresponding row in the data dictionary, as shown in [Dictionary template].

### Measurement results (columns J–AO: `texture` through `na_mg_kg`)

-   All measurement columns **except `texture`** must be numeric. Non-numeric
    values (e.g., `ND`, `<1`) will be coerced to `NA` and may be omitted from
    summaries, tables, and plots. Clean or recode censored values before
    uploading.

-   `texture` may be left blank. If at least two of `sand_percent`,
    `silt_percent`, and `clay_percent` are provided, `texture` will be
    classified using [USDA NRCS
    rules](https://www.nrcs.usda.gov/resources/education-and-teaching-materials/soil-texture-calculator).

    -   `sand_percent`, `silt_percent`, and `clay_percent` must:

        -   Be between 0 and 100

        -   Sum to 100 (± 1)

        -   Include at least two values per sample (the third will be calculated
            as 100 minus the sum of the other two)

-   Delete any columns for measurements not analyzed in your project.

-   Add columns for any additional measurements you wish to include.

    **Important:** Measurement column names in the `data` must match exactly
    match the `column_name` values in the `data_dictionary`. Update
    `data_dictionary` after adding or removing measurements.

## Dictionary template

The data dictionary is used to group and order soil measurements, and to nicely
format labels in tables and plots. The example `data_dictionary` contains
[UTF-8](https://www.unicode.org/faq/utf_bom.html) encoded superscripts,
subscripts, and special characters.

To properly encode your data dictionary as UTF-8, save it to the `data` folder
as `CSV UTF-8 (Comma delimited) (*.csv)` in MS Excel.

![](../man/figures/utf-8.png){fig-alt="Data dictionary is saved as CSV UTF-8 (Comma delimited) (*.csv) in MS Excel."}

<details closed>

<summary>Glimpse at the example data dictionary</summary>

```{r}
dplyr::glimpse(data_dictionary)
```

</details>

Your data dictionary **must have the below required columns** for every soil
measurement included in your data.

-   **`measurement_group <chr>`** defines how the soil measurements are grouped.
    Groups appear in the report in the order listed in the data dictionary.

    -   **Only the following values are currently supported. Custom groups are
        not allowed and will fail validation.**

        -   **English:** Physical, Biological, Chemical, Plant Essential Macro
            Nutrients, Plant Essential Micro Nutrients

        -   **Spanish:** Mediciones físicas, Mediciones biológicas, Mediciones
            químicas, Macronutrientes esenciales para plantas, Micronutrientes
            esenciales para plantas

-   **`column_name <chr>`** is used to join the dictionary with your data. Must
    exactly match the column names of the soil measurements in your data. Within
    each measurement group, measurements appear in the order listed in the data
    dictionary.

-   **`abbr <chr>`**: Abbreviation used in tables and plots. Shorter
    abbreviations improve readability.

-   **`unit <chr>`**: Unit of measurement displayed in tables and plots.

-   **`abbr`** + **`unit`**: Combination of abbreviation and unit must be unique
    for each measurement.

## Load your data into the template

Once your project data and dictionary files match the structure of the examples
and are saved in the `data` folder, follow along with the changes in the code
chunks in `01_producer-report.qmd`. Code you will need to change are marked with
the text "`EDIT:`". Find all edit markers in the RStudio project with `Ctrl` +
`Shift` + `F` to open the `Find in Files` wizard.

Below changes are for demonstration purposes only, the actual changes should be
based on **your** data and dictionary.

### `load-data` chunk

Replace `washi-data.csv` with the name of your data file (`my-data.csv`).

<details closed>

<summary>Example changed chunk</summary>

```{r load-data, eval=FALSE}
# EDIT: Add your cleaned lab data to the data folder, using 'washi-data.csv' as
# a template.

# Load lab results
data <- read.csv(
  here::here("data/my-data.csv"),
  check.names = FALSE,
  encoding = "UTF-8",
  strip.white = TRUE
)
```

</details>

### `load-dictionary` chunk

Change `data-dictionary.csv` to the name of your dictionary file
(`my-dictionary.csv`). If using subscripts, superscripts, or special characters,
make sure your csv is saved with UTF-8 encoding (see [Dictionary template] for
how to do this).

<details closed>

<summary>Example changed chunk</summary>

```{r load-dictionary, eval=FALSE}
# EDIT: Add your data dictionary to the data folder, using 'data-dictionary.csv'
# as a template.

# Load data dictionary
dictionary <- read.csv(
  here::here("data/my-dictionary.csv"),
  check.names = FALSE,
  # Set encoding for using subscripts, superscripts, special characters
  encoding = "UTF-8",
  strip.white = TRUE
)
```

</details>

### `tidy-long` chunk

As of {soils} version 1.0.1, measurement columns are automatically detected,
converted to numeric, and pivoted to a tidy long format. **All measurement
columns must be numeric**. Non-numeric values (e.g., `ND`, `<1`, `NA`, blanks,
or other characters) are coerced to `NA` and may be omitted from summaries,
tables, and plots. If you have additional metadata columns that should **not**
be converted or pivoted, add them to the `metadata_cols` vector.

<details closed>

<summary>Example changed chunk</summary>

```{r tidy-long, eval=FALSE}
# OPTIONAL EDIT: Add any extra metadata columns in `data` that should not be
# treated as measurements.
metadata_cols <- c(
  "year",
  "sample_id",
  "farm_name",
  "producer_id",
  "field_id",
  "county",
  "crop",
  "longitude",
  "latitude",
  "texture"
)

# Identify measurement columns
measurement_cols <- data |>
  dplyr::select(-dplyr::any_of(metadata_cols)) |>
  colnames()

# Coerce measurement columns to numeric; warns if values are converted to NA
data <- soils::coerce_to_numeric(data, measurement_cols)

# Tidy data into long format and join with data dictionary
results_long <- data |>
  tidyr::pivot_longer(
    cols = dplyr::all_of(measurement_cols),
    names_to = "measurement"
  ) |>
  ...
```

</details>

**See the [troubleshooting
article](https://wa-department-of-agriculture.github.io/soils/articles/troubleshoot.html)
for more help on debugging errors.**
