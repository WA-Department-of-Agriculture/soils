---
title: "![](images/logo.png) Results from [INSERT PROJECT NAME]"
subtitle: "[INSERT DATE]"
execute:
  echo: false
  warning: false
  output: true
knitr: 
  opts_chunk:
    dev: "ragg_png"
    tbl.cap: NULL
    ft.align: "left"
format: 
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    link-external-newwindow: true
    embed-resources: true
    css: resources/styles.css
  docx:
    reference-doc: resources/word-template.docx
resource-path: 
  - inst
format-links: false
fig-align: left
fig-width: 6
fig-height: 3.5
fig-dpi: 300
params:
  producerId: WUY05
  year: 2023
---

```{r setup}
library(soils)

# Get output file type
out_type <- knitr::opts_knit$get("rmarkdown.pandoc.to")

# Set path for saving figure output
path <- here::here("inst/figure_output/")

# Create figure output directory if needed
if (!dir.exists(path)) {
  dir.create(path)
}

# Run data wrangling script for current producer and year
pid <- params$producerId
yr <- params$year
source(here::here("R/tables.R"))
source(here::here("R/helpers.R"))
source(here::here("R/plots.R"))
source(here::here("R/map.R"))
source(here::here("R/data_wrangling.R"))

# EDIT: set order of measurement_groups
measurement_groups <- c("physical", "biological", "chemical", "macro", "micro")
```

## `r ifelse(!is.na(producer$farmName), producer$farmName, paste("Farm:", params$producerId))`

{{< include _01_project_summary.qmd >}}

{{< include _02_soil_health_background.qmd >}}

{{< pagebreak >}}

## Your Fields

```{r}
# do not add chunk label due to bug https://github.com/quarto-dev/quarto-cli/issues/3603
table_gis
```

```{r create-map}
map <- make_leaflet(gis_df)
```

```{r save-map}
if (requireNamespace("htmlwidgets", quietly = TRUE) &
  requireNamespace("webshot2", quietly = TRUE)) {
  invisible(htmlwidgets::saveWidget(
    map,
    file = paste0(path, "/map.html")
  ))
  invisible(webshot2::webshot(
    url = paste0(path, "/map.html"),
    file = paste0(path, "/map.png"),
  ))
}
```

```{r map-html}
#| eval: !expr out_type == "html"
map
```

```{r map-static}
#| eval: !expr out_type == "docx"
#| out-width: 6in
if (fs::file_exists(glue::glue("{path}/map.png"))) {
  knitr::include_graphics(
    glue::glue("{path}/map.png")
  )
}
```

{{< pagebreak >}}

## Project Results

Below are tables and graphs describing the physical, biological, and chemical measurements from your soils. Each point represents a sample we collected. Take a look to see how your fields compare to others in the project. All samples were collected from \[INSERT SOIL DEPTH (e.g. 0-6 inches, or 0-30 cm)\].

```{r create-measurement-group-sections}
#| output: asis
sections <- purrr::map_chr(measurement_groups, \(group) {
  knitr::knit_child(
    input = "section_template.qmd",
    envir = environment(),
    quiet = TRUE
  )
})

cat(sections, sep = "\n")
```

```{r download-data-text}
#| eval: !expr out_type == "html"
#| results: asis
if (requireNamespace("downloadthis", quietly = TRUE)) {
  cat("## Download your data")
}
```

```{r download-data}
#| eval: !expr out_type == "html"
if (requireNamespace("downloadthis", quietly = TRUE)) {
  list(
    results = subset(data, producerId == pid),
    measurement_dictionary = dictionary[
      ,
      c(
        "column_name",
        "measurement_full_name",
        "abbr",
        "unit"
      )
    ]
  ) |>
    downloadthis::download_this(
      output_name = glue::glue("{params$year}_soils_data"),
      output_extension = ".xlsx",
      button_label = "Download as Excel spreadsheet",
      button_type = "success"
    )
}
```

## Looking Forward

{{< include _06_looking_forward.qmd >}}

## Acknowledgement

{{< include _07_acknowledgement.qmd >}}
